<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario con Items Dinámicos</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<div></div>
<div style="width: 80%;" id="formulario-container">
  <!-- Este div estará vacío, se llenará con los datos obtenidos -->
</div>

<script>
  fetch('http://localhost:8080/api/v1/encabezado')
    .then(response => response.json())
    .then(data => {
      const formContainer = document.getElementById('formulario-container');

      if (data && Array.isArray(data.data)) {
        data.data.forEach(encabezado => {
          const columna = document.createElement('div');
          columna.classList.add('column');

          const tituloEncabezado = document.createElement('h1');
          tituloEncabezado.textContent = encabezado.descripcion;
          columna.appendChild(tituloEncabezado);

          encabezado.item.forEach(item => {
            const campo = document.createElement('div');
            campo.classList.add('field');

            const label = document.createElement('label');
            label.setAttribute('for', `item_${item.id}`);
            label.textContent = `${item.nombre} - ${item.valor}`; // Mostrar el nombre del ítem y su valor
            campo.appendChild(label);

            const input = document.createElement('input');
            input.setAttribute('type', 'number');
            input.setAttribute('id', `item_${item.id}`);
            input.setAttribute('name', `item_${item.id}`);
            input.setAttribute('min', '0');
            input.setAttribute('step', '0.01'); // Permitir valores decimales
            campo.appendChild(input);

            const resultado = document.createElement('input');
            resultado.setAttribute('type', 'text');
            resultado.setAttribute('readonly', 'readonly');
            campo.appendChild(resultado);

            input.addEventListener('input', () => {
              const value = parseFloat(input.value) || 0;
              const multiplicacion = value * parseFloat(item.valor) || 0; // Calcular la multiplicación con el valor del ítem
              resultado.value = multiplicacion.toFixed(2); // Mostrar el resultado con dos decimales

              // Recalcular la suma total de las multiplicaciones para el encabezado actual
              const inputs = encabezado.item.map(encItem => parseFloat(document.getElementById(`item_${encItem.id}`).value) || 0);
              const totalMultiplicaciones = encabezado.item.reduce((total, encItem, index) => {
                return total + (parseFloat(encItem.valor) || 0) * inputs[index];
              }, 0);

              const resultadoTotal = columna.querySelector('input[name="item_Total"]');
              if (resultadoTotal) {
                resultadoTotal.value = totalMultiplicaciones.toFixed(2); // Mostrar el total con dos decimales
              }
            });

            columna.appendChild(campo);
          });

          formContainer.appendChild(columna);
        });
      } else {
        console.error('El formato de datos no es el esperado');
      }
    })
    .catch(error => {
      console.error('Hubo un error al obtener los datos:', error);
    });
</script>

</body>
</html>
