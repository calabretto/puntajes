<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario con Items Dinámicos</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<div></div>
<div style="width: 80%;" id="formulario-container">
  <!-- Este div estará vacío, se llenará con los datos obtenidos -->
</div>

<script>
  fetch('http://localhost:8080/api/v1/encabezado')
    .then(response => response.json())
    .then(data => {
      const formContainer = document.getElementById('formulario-container');

      if (data && Array.isArray(data.data)) {
        data.data.forEach(encabezado => {
          const columna = document.createElement('div');
          columna.classList.add('column');

          const tituloEncabezado = document.createElement('h1');
          tituloEncabezado.textContent = `${encabezado.descripcion} - Máximo: ${encabezado.maximo} pts`;
          columna.appendChild(tituloEncabezado);

          const itemsContainer = document.createElement('div'); // Contenedor para los items
          encabezado.item.forEach(item => {
            const campo = document.createElement('div');
            campo.classList.add('field');

            const label = document.createElement('label');
            label.setAttribute('for', `item_${item.id}`);
            label.textContent = `${item.nombre} - ${item.valor}`; // Mostrar el nombre del ítem y su valor
            campo.appendChild(label);

            const input = document.createElement('input');
            input.setAttribute('type', 'number');
            input.setAttribute('id', `item_${item.id}`);
            input.setAttribute('name', `item_${item.id}`);
            input.setAttribute('min', '0');
            input.setAttribute('step', '1'); // Permitir valores decimales
            campo.appendChild(input);

            const resultado = document.createElement('input');
            resultado.setAttribute('type', 'text');
            resultado.setAttribute('readonly', 'readonly');
            campo.appendChild(resultado);

            input.addEventListener('input', () => {
              const value = parseFloat(input.value) || 0;
              const multiplicacion = value * parseFloat(item.valor) || 0; // Calcular la multiplicación con el valor del ítem
              resultado.value = multiplicacion.toFixed(2); // Mostrar el resultado con dos decimales
              calculateTotal(); // Calcular y mostrar el total cada vez que se modifica un valor
            });

            itemsContainer.appendChild(campo);
          });

          const totalCampo = document.createElement('div'); // Campo para el total
          totalCampo.classList.add('field');

          const labelTotal = document.createElement('label');
          labelTotal.textContent = `Total ${encabezado.descripcion}`;
          totalCampo.appendChild(labelTotal);

          const totalEncabezado = document.createElement('input');
          totalEncabezado.setAttribute('type', 'text');
          totalEncabezado.setAttribute('readonly', 'readonly');
          totalCampo.appendChild(totalEncabezado);

          columna.appendChild(itemsContainer);
          columna.appendChild(totalCampo);
          formContainer.appendChild(columna);

          function calculateTotal() {
            const inputs = itemsContainer.querySelectorAll('input[type="number"]');
            let sum = 0;
            inputs.forEach(input => {
              const value = parseFloat(input.value) || 0;
              const itemId = parseInt(input.getAttribute('id').split('_')[1]);
              const item = encabezado.item.find(item => item.id === itemId);
              const multiplicacion = value * parseFloat(item.valor) || 0;
              sum += multiplicacion;
            });
            totalEncabezado.value = Math.min(sum, encabezado.maximo).toFixed(2);
          }

          calculateTotal(); // Calcular y mostrar el total inicial

          if (encabezado.descripcion === 'Específico' && encabezado.parcial) {
            const sumTotalesParciales = document.createElement('div'); // Campo para la suma de totales parciales
            sumTotalesParciales.classList.add('field');

            const labelSumTotalesParciales = document.createElement('label');
            labelSumTotalesParciales.textContent = 'Suma de Totales Parciales Anteriores';
            sumTotalesParciales.appendChild(labelSumTotalesParciales);

            const sumEncabezadosParciales = data.data
              .filter(e => e.parcial && e.descripcion !== 'Específico') // Filtrar encabezados parciales excluyendo el específico
              .reduce((acc, curr) => {
                return acc + parseFloat(curr.maximo); // Sumar los totales de los encabezados parciales
              }, 0);

            const sumEncabezadosParcialesInput = document.createElement('input');
            sumEncabezadosParcialesInput.setAttribute('type', 'text');
            sumEncabezadosParcialesInput.setAttribute('readonly', 'readonly');
            sumEncabezadosParcialesInput.value = sumEncabezadosParciales.toFixed(2);
            sumTotalesParciales.appendChild(sumEncabezadosParcialesInput);

            formContainer.appendChild(sumTotalesParciales);
          }
        });
      } else {
        console.error('El formato de datos no es el esperado');
      }
    })
    .catch(error => {
      console.error('Hubo un error al obtener los datos:', error);
    });
</script>

</body>
</html>
